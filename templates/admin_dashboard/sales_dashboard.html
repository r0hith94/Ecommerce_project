{% extends 'base.html' %}

{% block title %}Sales Dashboard - Admin{% endblock %}

{% block content %}
<a href="{% url 'products:sql_executor' %}" class="btn btn-warning me-2">
    <i class="fas fa-code"></i> SQL Executor
</a>
<div class="container-fluid my-4">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fas fa-chart-line"></i> Sales Analytics Dashboard</h2>
            <p class="text-muted">Admin Overview - Database Analytics</p>
        </div>
        <!-- <div class="col text-end">
            <a href="{% url 'products:home' %}" class="btn btn-outline-primary">
                <i class="fas fa-home"></i> Back to Home
            </a>
        </div> -->
        <div class="col text-end">
    <a href="{% url 'products:show_sql_queries' %}" class="btn btn-success me-2">
        <i class="fas fa-database"></i> View Raw SQL
    </a>
    <a href="{% url 'products:home' %}" class="btn btn-outline-primary">
        <i class="fas fa-home"></i> Back to Home
    </a>
</div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-white-50">Total Revenue</h6>
                            <h3 class="mb-0">₹{{ total_revenue|floatformat:0 }}</h3>
                        </div>
                        <div>
                            <i class="fas fa-rupee-sign fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-white-50">Total Orders</h6>
                            <h3 class="mb-0">{{ total_orders }}</h3>
                        </div>
                        <div>
                            <i class="fas fa-shopping-bag fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-white-50">Total Customers</h6>
                            <h3 class="mb-0">{{ total_customers }}</h3>
                        </div>
                        <div>
                            <i class="fas fa-users fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-white shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-white-50">Pending Orders</h6>
                            <h3 class="mb-0">{{ pending_orders }}</h3>
                        </div>
                        <div>
                            <i class="fas fa-clock fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- This Month Stats -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-body">
                    <h5><i class="fas fa-calendar-alt"></i> This Month</h5>
                    <p class="mb-1"><strong>Revenue:</strong> ₹{{ month_revenue|floatformat:0 }}</p>
                    <p class="mb-0"><strong>Today's Orders:</strong> {{ today_orders }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-body">
                    <h5><i class="fas fa-chart-pie"></i> Orders by Status</h5>
                    {% for status in orders_by_status %}
                    <span class="badge bg-secondary me-2">
                        {{ status.status|title }}: {{ status.count }}
                    </span>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Top Selling Products -->
        <div class="col-md-6 mb-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-trophy"></i> Top 5 Selling Products</h5>
                    <small>SQL: GROUP BY, SUM(), ORDER BY</small>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Product</th>
                                <th>Sold</th>
                                <th>Revenue</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in top_products %}
                            <tr>
                                <td>{{ product.product__name|truncatewords:3 }}</td>
                                <td><span class="badge bg-success">{{ product.total_sold }} units</span></td>
                                <td><strong>₹{{ product.revenue|floatformat:0 }}</strong></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-muted">No sales yet</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sales by Category -->
        <div class="col-md-6 mb-4">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-tags"></i> Sales by Category</h5>
                    <small>SQL: JOIN, GROUP BY, SUM()</small>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Category</th>
                                <th>Units</th>
                                <th>Revenue</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cat in category_sales %}
                            <tr>
                                <td>{{ cat.product__category__name }}</td>
                                <td><span class="badge bg-info">{{ cat.total_sold }}</span></td>
                                <td><strong>₹{{ cat.revenue|floatformat:0 }}</strong></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-muted">No data</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Low Stock Alert -->
        <div class="col-md-6 mb-4">
            <div class="card shadow border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Low Stock Alert</h5>
                    <small>SQL: WHERE stock &lt; 10</small>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Product</th>
                                <th>Stock</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in low_stock_products %}
                            <tr>
                                <td>{{ product.name|truncatewords:4 }}</td>
                                <td>
                                    <span class="badge bg-danger">{{ product.stock }} left</span>
                                </td>
                                <td>
                                    <a href="/admin/products/product/{{ product.id }}/change/" 
                                       class="btn btn-sm btn-outline-primary" target="_blank">
                                        Update
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-success">
                                    <i class="fas fa-check-circle"></i> All products have sufficient stock
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Recent Orders -->
        <div class="col-md-6 mb-4">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Recent Orders</h5>
                    <small>SQL: ORDER BY created_at DESC LIMIT 10</small>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in recent_orders %}
                            <tr>
                                <td>
                                    <a href="/admin/orders/order/{{ order.id }}/change/" target="_blank">
                                        {{ order.order_number }}
                                    </a>
                                </td>
                                <td>{{ order.user.username }}</td>
                                <td>₹{{ order.total_amount }}</td>
                                <td>
                                    <span class="badge bg-{% if order.status == 'delivered' %}success{% elif order.status == 'cancelled' %}danger{% else %}warning{% endif %}">
                                        {{ order.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">No orders yet</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    


    
    <!-- SQL Queries Used -->
    <div class="row mt-4">
        <div class="col">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-database"></i> SQL Queries Demonstrated</h5>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li><strong>Aggregate Functions:</strong> SUM(), COUNT(), AVG()</li>
                        <li><strong>Joins:</strong> INNER JOIN (products with categories)</li>
                        <li><strong>Group By:</strong> Grouping sales by product and category</li>
                        <li><strong>Ordering:</strong> ORDER BY revenue DESC, stock ASC</li>
                        <li><strong>Filtering:</strong> WHERE stock &lt; 10, status = 'pending'</li>
                        <li><strong>Date Functions:</strong> Filtering by month and date</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}